<!DOCTYPE html>
<html lang="en">

<head>
    <title>AVISENA - Iniciar Sesión</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Proyecto AVISENA">
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media">
    <link rel="shortcut icon" href="favicon.png">

    <!-- FontAwesome JS-->
    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>

    <!-- App CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css">

</head>

<body class="app app-login p-0 bg-light">
    <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center p-4">
        <div class="row g-0 shadow-lg rounded-4 overflow-hidden bg-white p-2"
            style="max-width: 850px; width: 100%; min-height: 520px;">
            <!-- Formulario izquierda -->
            <div class="col-12 col-md-6 col-lg-6 p-4">
                <div class="d-flex flex-column justify-content-center">
                    <!-- Logo arriba -->
                    <div class="text-center mb-3">
                        <img src="assets/images/logo-avisena-solo-gallina.png" alt="AVISENA"
                            style="max-width: 60px; min-height: 1px;">
                    </div>

                    <!-- Encabezado -->
                    <div class="text-center mb-3">
                        <h3 class="fw-bold mb-2" style="color: #2c3e50;">AVISENA</h3>
                        <p class="text-muted small">Te damos la bienvenida!</p>
                    </div>

                    <form class="auth-form login-form">
                        <!-- Campo Email -->
                        <div class="mb-3">
                            <input id="signin-email" name="signin-email" type="email"
                                class="form-control border-2 rounded-3 px-3" placeholder="Ingrese su correo" required
                                style="background-color: #f8f9fa; border-color: #e9ecef;">
                        </div>

                        <!-- Campo Password -->
                        <div class="mb-2">
                            <div class="input-group">
                                <input id="signin-password" name="signin-password" type="password"
                                    class="form-control border-2 rounded-start px-3" placeholder="Contraseña" required
                                    style="background-color: #f8f9fa; border-color: #e9ecef; border-right: none;">

                                <button class="btn rounded-end m-0 p-0 px-3" type="button" id="togglePassword"
                                    style="background-color: #f8f9fa; border: 2px solid #e9ecef; border-left: none;">
                                    <i class="fas fa-eye text-muted" id="eyeIcon"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Error message -->
                        <div id="error-message" class="text-danger text-center mb-2 small"></div>

                        <!-- Recovery Password -->
                        <div class="text-end mb-4">
                            <a href="reset-password.html" class="small text-decoration-underline">Recuperar contraseña
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
                                    class="bi bi-arrow-up-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M14 2.5a.5.5 0 0 0-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                                </svg></a>
                        </div>

                        <!-- Botón Sign In -->
                        <div class="mb-3">
                            <button id="login"
                                class="btn w-100 text-white fw-semibold rounded-3 shadow-sm d-flex align-items-center justify-content-center"
                                style="background: linear-gradient(90deg, #5cb377 0%, #218838 100%); border: none; min-height: 40px; font-size: 0.9rem;"
                                type="submit">
                                <span>Iniciar sesión</span>
                                <span id="login-spinner" class="spinner-border spinner-border-sm ms-2 d-none"
                                    role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>

                    <!-- Footer -->
                    <div class=" text-center mt-5">
                        <small class="text-muted">Diseñado por ADSO 2925889</small>
                    </div>
                </div>
            </div>

            <!-- Ilustración lateral derecha -->
            <div class="col-12 col-md-6 col-lg-6 rounded-4 d-none d-md-block position-relative overflow-hidden"
                style="background: url('assets/images/backgrpun-login.png') center/cover;">
                <div class="d-flex flex-column align-items-center justify-content-center h-100 p-4 position-relative">
                </div>
            </div>
        </div>
</body>
<script>

    const boton = document.getElementById("login");

    boton.addEventListener("click", (event) => {
        event.preventDefault(); //Evita que el formulario se envie de la forma 
        // lo que que quiero que se ejecute cuando en el boton hagan click
        // URL del endpoint de autenticación en el servidor
        const loginUrl = "https://api.avisena.store/access/token";

        let correo = document.getElementById("signin-email").value;
        let contrasenia = document.getElementById("signin-password").value;

        // Crear objeto URLSearchParams para enviar datos como formulario
        const formData = new URLSearchParams(); //limpia los datos que pongamos ahi dentro y lps envia como formulario

        // Agregar credenciales al formulario
        formData.append("username", correo);  // Email del usuario
        formData.append("password", contrasenia);       // Contraseña del usuario

        // Realizar petición HTTP POST al servidor
        fetch(loginUrl, {
            method: "POST",  // Método HTTP para enviar datos
            headers: {
                // Especifica que enviamos datos de formulario codificados en URL
                "Content-Type": "application/x-www-form-urlencoded",
                // Especifica que esperamos recibir JSON como respuesta
                "accept": "application/json"
            },
            body: formData  // Datos del formulario a enviar
        })
            .then(response => {
                // Verificar si la respuesta fue exitosa (status 200-299)
                if (!response.ok) {
                    // Si hay error, convertir respuesta a JSON y lanzar excepción
                    return response.json().then(err => { throw err });
                }
                // Si todo está bien, convertir respuesta a JSON
                return response.json();
            })
            .then(data => {
                // Manejar respuesta exitosa del servidor
                console.log("Login exitoso:", data);

                // Guardar token de acceso en localStorage del navegador
                localStorage.setItem("access_token", data.access_token);

                // Guardar información del usuario en localStorage (convertida a JSON)
                localStorage.setItem("user", JSON.stringify(data.user));

                // REDIRECCIÓN DESPUÉS DEL LOGIN EXITOSO
                // Opción 1: Redirección inmediata
                window.location.href = "index.html";

                // Opción 2: Reemplazar la página actual (no permite volver atrás)
                // window.location.replace("dashboard.html");
            })
            .catch(error => {
                // Manejar cualquier error que ocurra durante el proceso
                console.error("Error en login:", error);
                const mensaje = document.getElementById('error-message');
                mensaje.innerHTML = error.detail;
            });
    });

    // Toggle password visibility
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('signin-password');
    const eyeIcon = document.getElementById('eyeIcon');

    togglePassword.addEventListener('click', function () {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;

        // Cambiar icono
        if (type === 'password') {
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        } else {
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        }
    });

</script>
<script src="./assets/js/main.js"></script>

</html>