<!DOCTYPE html>
<html lang="es">
  <head>
    <title>AVISENA - Restablecer Contraseña</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Restablece tu contraseña - Plataforma AVISENA"/>
    <meta name="author" content="ADSO 2925889" />
    <link rel="icon" type="image/png" href="assets/images/logo-avisena-solo-gallina.png">

    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css" />
  </head>

  <body class="app app-reset-password p-0 bg-light">
    <div class="row g-0 app-auth-wrapper">
      <div class="col-12 app-auth-wrapper text-center p-3 p-md-5">
        <div class="d-flex flex-column align-content-end rounded-3 bg-white">
          <div class="card shadow-lg border-0 rounded-4 p-3 p-sm-4 p-md-5 app-auth-body mx-auto bg-white" style="width: 100%; max-width: 600px">
            <div class="card-body app-auth-branding mb-3 mb-md-4">
              <a class="app-logo" href="index.html">
                <img class="logo-icon me-2" src="assets/images/logo-avisena-solo-gallina.png" alt="Logo AVISENA" style="max-width: 100px"/>
              </a>
            </div>
            <h2 class="auth-heading text-center mb-3 mb-md-4 fs-4 fs-md-3">Restablecer Contraseña</h2>
            <div class="auth-intro mb-3 mb-md-4 text-center px-2">Ingresa tu correo electrónico y te enviaremos un código de 6 dígitos para restablecer tu contraseña.</div>
            <div class="auth-form-container text-start">
              <form class="auth-form resetpass-form" id="reset-form">
                <div class="email mb-3">
                  <label class="sr-only" for="reset-email">Correo electrónico</label>
                  <input id="reset-email" name="reset-email" type="email" class="form-control" placeholder="Correo electrónico" required/>
                </div>

                <div id="reset-message" class="text-center mb-3"></div>
                <div class="text-center">
                  <button id="reset-btn" type="submit" class="btn app-btn-primary w-100 w-sm-75 w-md-50 theme-btn mx-auto">
                    <span id="btn-text">Enviar código</span>
                    <span id="btn-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                  </button>
                </div>
              </form>
              <div class="auth-option text-center pt-4 pt-md-5">
				¿Ya la recordaste?
                <a class="text-link" href="index.html">Inicia sesión</a>
              </div>
            </div>
          </div>
          <footer class="app-auth-footer mt-3 mt-md-4">
            <div class="container text-center py-3">
              <small class="copyright">Diseñada por ADSO 2925889</small>
            </div>
          </footer>
        </div>
      </div>
    </div>
    <script>
      const API_URL = "https://api.avisena.store";

      const form = document.getElementById("reset-form");
      const msg = document.getElementById("reset-message");
      const btnText = document.getElementById("btn-text");
      const btnSpinner = document.getElementById("btn-spinner");
      const btnSubmit = document.getElementById("reset-btn");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const email = document.getElementById("reset-email").value;

        msg.className = "text-center mb-3";
        msg.innerHTML = "";

        btnSubmit.disabled = true;
        btnText.textContent = "Conectando...";
        btnSpinner.classList.remove("d-none");

        msg.innerHTML = `
				<div class="alert alert-success" role="alert">
					<div class="spinner-border spinner-border-sm me-2" role="status"></div>
					<strong>Conectando con el servidor...</strong>
				</div>
			`;

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000);

          btnText.textContent = "Enviando...";

          const response = await fetch(`${API_URL}/access/forgot-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ email: email }),
            signal: controller.signal,
          });

          clearTimeout(timeoutId);
          const data = await response.json();

          if (response.ok) {
            msg.innerHTML = `
						<div class="alert alert-success" role="alert">
							<i class="fas fa-check-circle me-2"></i>
							${data.message}
							<br><br>
							<strong>Revisa tu bandeja de entrada y tu carpeta de spam.</strong>
						</div>
					`;

            sessionStorage.setItem("reset-email", email);

            setTimeout(() => {
              window.location.href = "confirm-reset-password.html";
            }, 3000);

            form.reset();
          } else {
            msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-exclamation-circle me-2"></i>
							${data.detail || "Error al procesar la solicitud"}
						</div>
					`;
          }
        } catch (error) {
          if (error.name === "AbortError") {
            msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-clock me-2"></i>
							<strong>Tiempo de espera agotado</strong>
							<br>
							El servidor tardó demasiado. Intenta de nuevo.
						</div>
					`;
          } else {
            msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-times-circle me-2"></i>
							No se pudo conectar con el servidor.
							<br>
							<small class="text-muted">${error.message}</small>
						</div>
					`;
          }
        } finally {
          btnSubmit.disabled = false;
          btnText.textContent = "Enviar código";
          btnSpinner.classList.add("d-none");
        }
      });
    </script>
    <script src="./assets/js/main.js"></script>
  </body>
</html>
