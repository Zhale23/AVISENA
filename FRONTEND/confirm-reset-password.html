<!DOCTYPE html>
<html lang="es">

<head>
	<title>AVISENA - Confirmar Nueva Contraseña</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Confirma tu nueva contraseña - Plataforma AVISENA">
	<meta name="author" content="ADSO 2925889">
	<link rel="icon" type="image/png" href="assets/images/logo-avisena-solo-gallina.png">

	<script defer src="assets/plugins/fontawesome/js/all.min.js"></script>
	<link id="theme-style" rel="stylesheet" href="assets/css/portal.css">
	<style>
		.code-input {
			width: 50px;
			height: 50px;
			text-align: center;
			font-size: 24px;
			font-weight: bold;
			margin: 0 5px;
			border: 2px solid #dee2e6;
			border-radius: 8px;
		}
		.code-input:focus {
			border-color: #0d6efd;
			box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
		}
		.code-container {
			display: flex;
			justify-content: center;
			margin: 20px 0;
		}
		.password-strength {
			height: 5px;
			border-radius: 3px;
			margin-top: 5px;
			transition: all 0.3s;
		}
		.strength-weak { background-color: #dc3545; width: 33%; }
		.strength-medium { background-color: #ffc107; width: 66%; }
		.strength-strong { background-color: #28a745; width: 100%; }
	</style>
</head>

<body class="app app-reset-password p-0">
	<div class="row g-0 app-auth-wrapper min-vh-100">
		<div class="col-lg-6 auth-main-col text-center p-3 p-md-5 d-flex flex-column">
			<div class="card shadow-lg d-flex flex-column align-content-end flex-grow-1 p-4">
				<div class="app-auth-body mx-auto" style="max-width: 500px; width: 100%;">
					<div class="app-auth-branding mb-3 mb-md-4">
						<a class="app-logo" href="index.html">
							<img class="logo-icon me-2" src="assets/images/logo-avisena-solo-gallina.png" alt="Logo AVISENA" style="max-width: 80px;">
						</a>
					</div>
					<h2 class="auth-heading text-center mb-3 mb-md-4">Ingresa tu código</h2>
					<div class="auth-intro mb-3 mb-md-4 text-center px-2">
						Hemos enviado un código de 6 dígitos a tu correo electrónico.
						<br>
						<strong id="user-email" class="text-primary"></strong>
					</div>
					<div class="auth-form-container text-start">
						<div class="mb-4">
							<label class="form-label text-center d-block">Código de verificación</label>
							<div class="code-container d-flex justify-content-center gap-2 mb-2">
								<input type="text" maxlength="1" class="code-input form-control text-center" id="code-1" required style="max-width: 40px;">
								<input type="text" maxlength="1" class="code-input form-control text-center" id="code-2" required style="max-width: 40px;">
								<input type="text" maxlength="1" class="code-input form-control text-center" id="code-3" required style="max-width: 40px;">
								<input type="text" maxlength="1" class="code-input form-control text-center" id="code-4" required style="max-width: 40px;">
								<input type="text" maxlength="1" class="code-input form-control text-center" id="code-5" required style="max-width: 40px;">
								<input type="text" maxlength="1" class="code-input form-control text-center" id="code-6" required style="max-width: 40px;">
							</div>
							<div class="text-center">
								<small class="text-muted">El código expira en 1 hora</small>
							</div>
							<div class="text-center mt-3 mt-md-4">
								<a href="index.html" class="text-link">
									Volver al inicio
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="col-12 col-lg-6 auth-main-col text-center p-3 p-md-5 d-flex flex-column rounded-4 min-vh-100">
			<div class="card shadow-lg border-0 d-flex flex-column align-content-end flex-grow-1 p-4">
				<div class="app-auth-body mx-auto" style="max-width: 500px; width: 100%;">
					<h3 class="mb-3 mb-md-4">Nueva contraseña</h3>
					
					<form class="auth-form resetpass-form text-start" id="confirm-reset-form">
						<div class="password mb-3">
							<label class="form-label" for="new-password">Nueva contraseña</label>
							<div class="input-group">
								<input id="new-password" name="new-password" type="password" class="form-control"
									placeholder="Mínimo 9 caracteres" required minlength="9">
								<button class="btn btn-secondary" type="button" id="toggle-password">
									<i class="fas fa-eye" id="eye-icon"></i>
								</button>
							</div>
							<div class="password-strength mt-2" id="password-strength"></div>
							<small class="text-muted" id="strength-text"></small>
						</div>

						<div class="password mb-4">
							<label class="form-label" for="confirm-password">Confirmar contraseña</label>
							<input id="confirm-password" name="confirm-password" type="password" class="form-control"
								placeholder="Repite la contraseña" required minlength="9">
							<small class="text-danger d-none" id="password-match-error">Las contraseñas no coinciden</small>
						</div>

						<div id="confirm-message" class="text-center mb-3"></div>

						<div class="text-center">
							<button id="confirm-btn" type="submit" class="btn app-btn-primary w-100 theme-btn mx-auto">
								<span id="btn-text">Restablecer contraseña</span>
								<span id="btn-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
							</button>
						</div>
					</form>

					<div class="text-center mt-3 mt-md-4">
						<a href="reset-password.html" class="text-link">
							<i class="fas fa-arrow-left me-2"></i>Volver a solicitar código
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		const API_URL = 'https://api.avisena.store';

		const savedEmail = sessionStorage.getItem('reset-email');
		if (savedEmail) {
			document.getElementById('user-email').textContent = savedEmail;
		} else {
			window.location.href = 'reset-password.html';
		}

		const codeInputs = document.querySelectorAll('.code-input');
		
		codeInputs.forEach((input, index) => {
			input.addEventListener('input', function(e) {
				this.value = this.value.replace(/[^0-9]/g, '');
				
				if (this.value && index < codeInputs.length - 1) {
					codeInputs[index + 1].focus();
				}
			});

			input.addEventListener('keydown', function(e) {
				if (e.key === 'Backspace' && !this.value && index > 0) {
					codeInputs[index - 1].focus();
				}
			});

			input.addEventListener('paste', function(e) {
				e.preventDefault();
				const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
				
				if (pastedData.length === 6) {
					pastedData.split('').forEach((char, i) => {
						if (codeInputs[i]) {
							codeInputs[i].value = char;
						}
					});
					codeInputs[5].focus();
				}
			});
		});

		document.getElementById('toggle-password').addEventListener('click', function() {
			const passwordInput = document.getElementById('new-password');
			const eyeIcon = document.getElementById('eye-icon');
			
			if (passwordInput.type === 'password') {
				passwordInput.type = 'text';
				eyeIcon.classList.remove('fa-eye');
				eyeIcon.classList.add('fa-eye-slash');
			} else {
				passwordInput.type = 'password';
				eyeIcon.classList.remove('fa-eye-slash');
				eyeIcon.classList.add('fa-eye');
			}
		});

		document.getElementById('new-password').addEventListener('input', function() {
			const password = this.value;
			const strengthBar = document.getElementById('password-strength');
			const strengthText = document.getElementById('strength-text');
			
			let strength = 0;
			if (password.length >= 9) strength++;
			if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
			if (/[0-9]/.test(password)) strength++;
			if (/[^a-zA-Z0-9]/.test(password)) strength++;

			strengthBar.className = 'password-strength';
			
			if (strength <= 1) {
				strengthBar.classList.add('strength-weak');
				strengthText.textContent = 'Contraseña débil';
				strengthText.className = 'text-danger';
			} else if (strength <= 2) {
				strengthBar.classList.add('strength-medium');
				strengthText.textContent = 'Contraseña media';
				strengthText.className = 'text-warning';
			} else {
				strengthBar.classList.add('strength-strong');
				strengthText.textContent = 'Contraseña fuerte';
				strengthText.className = 'text-success';
			}
		});

		document.getElementById('confirm-password').addEventListener('input', function() {
			const password = document.getElementById('new-password').value;
			const confirmPassword = this.value;
			const errorMsg = document.getElementById('password-match-error');
			
			if (confirmPassword && password !== confirmPassword) {
				errorMsg.classList.remove('d-none');
			} else {
				errorMsg.classList.add('d-none');
			}
		});

		const form = document.getElementById('confirm-reset-form');
		const msg = document.getElementById('confirm-message');
		const btnText = document.getElementById('btn-text');
		const btnSpinner = document.getElementById('btn-spinner');
		const btnSubmit = document.getElementById('confirm-btn');

		form.addEventListener('submit', async function(e) {
			e.preventDefault();

			const code = Array.from(codeInputs).map(input => input.value).join('');
			const newPassword = document.getElementById('new-password').value;
			const confirmPassword = document.getElementById('confirm-password').value;

			if (code.length !== 6) {
				msg.innerHTML = `
					<div class="alert alert-warning" role="alert">
						<i class="fas fa-exclamation-triangle me-2"></i>
						Por favor ingresa los 6 dígitos del código
					</div>
				`;
				return;
			}

			if (newPassword !== confirmPassword) {
				msg.innerHTML = `
					<div class="alert alert-warning" role="alert">
						<i class="fas fa-exclamation-triangle me-2"></i>
						Las contraseñas no coinciden
					</div>
				`;
				return;
			}

			if (newPassword.length < 9) {
				msg.innerHTML = `
					<div class="alert alert-warning" role="alert">
						<i class="fas fa-exclamation-triangle me-2"></i>
						La contraseña debe tener al menos 9 caracteres
					</div>
				`;
				return;
			}

			msg.className = 'text-center mb-3';
			msg.innerHTML = '';

			btnSubmit.disabled = true;
			btnText.textContent = 'Procesando...';
			btnSpinner.classList.remove('d-none');

			try {
				const response = await fetch(`${API_URL}/access/reset-password`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						token: code,
						new_password: newPassword
					})
				});

				const data = await response.json();

				if (response.ok) {
					msg.innerHTML = `
						<div class="alert alert-success" role="alert">
							<i class="fas fa-check-circle me-2"></i>
							${data.message}
							<br><br>
							<strong>Redirigiendo al inicio de sesión...</strong>
						</div>
					`;
					
					sessionStorage.removeItem('reset-email');
					
					setTimeout(() => {
						window.location.href = 'index.html';
					}, 3000);
				} else {
					msg.innerHTML = `
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-exclamation-circle me-2"></i>
							${data.detail || 'Error al restablecer la contraseña'}
						</div>
					`;
					
					btnSubmit.disabled = false;
					btnText.textContent = 'Restablecer contraseña';
					btnSpinner.classList.add('d-none');
				}
			} catch (error) {
				msg.innerHTML = `
					<div class="alert alert-danger" role="alert">
						<i class="fas fa-times-circle me-2"></i>
						No se pudo conectar con el servidor. Verifica tu conexión.
					</div>
				`;
				console.error('Error:', error);
				
				btnSubmit.disabled = false;
				btnText.textContent = 'Restablecer contraseña';
				btnSpinner.classList.add('d-none');
			}
		});
	</script>
	<script src="./assets/js/main.js"></script>
</body>
</html>
