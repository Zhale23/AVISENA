<!-- Panel de Control AVISENA -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <h1 class="app-page-title mb-1">Panel de Control</h1>
        <p class="text-muted">Monitoreo en tiempo real de la granja avícola AVISENA</p>
    </div>
</div>

<!-- Tarjetas de Métricas Principales -->
<div class="row g-3 mb-4">
    <!-- Total Gallinas -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Total Gallinas</p>
                        <h2 class="mb-0 fw-bold" id="total-gallinas">---</h2>
                        <small class="text-success"><i class="fas fa-arrow-up"></i> <span
                                id="gallinas-trend">+2.5%</span> vs mes anterior</small>
                    </div>
                    <div class="p-3 bg-primary bg-opacity-10 rounded">
                        <i class="fas fa-egg fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Producción de Huevos -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Producción Hoy</p>
                        <h2 class="mb-0 fw-bold" id="produccion-hoy">---</h2>
                        <small class="text-success"><i class="fas fa-arrow-up"></i> <span
                                id="produccion-trend">+5.8%</span> vs ayer</small>
                    </div>
                    <div class="p-3 bg-success bg-opacity-10 rounded">
                        <i class="fas fa-chart-line fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Galpones Activos -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Galpones Activos</p>
                        <h2 class="mb-0 fw-bold" id="galpones-activos">---</h2>
                        <small class="text-info"><i class="fas fa-check-circle"></i> <span id="galpones-estado">Todos
                                operativos</span></small>
                    </div>
                    <div class="p-3 bg-info bg-opacity-10 rounded">
                        <i class="fas fa-warehouse fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas Activas -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Alertas Activas</p>
                        <h2 class="mb-0 fw-bold" id="alertas-activas">---</h2>
                        <small class="text-warning"><i class="fas fa-exclamation-triangle"></i> <span
                                id="alertas-estado">Revisar incidentes</span></small>
                    </div>
                    <div class="p-3 bg-warning bg-opacity-10 rounded">
                        <i class="fas fa-bell fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficas y Accesos Directos -->
<div class="row g-3 mb-4">
    <!-- Gráfica de Producción Semanal -->
    <div class="col-12 col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="card-title mb-0">Producción de Huevos - Últimos 7 Días</h5>
                        <small class="text-muted">Comparativa semanal de producción</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" data-period="7">7D</button>
                        <button class="btn btn-outline-secondary" data-period="30">30D</button>
                        <button class="btn btn-outline-secondary" data-period="90">90D</button>
                    </div>
                </div>
                <canvas id="produccionChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Accesos Directos -->
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Accesos Directos</h5>
                <div class="d-grid gap-2">
                    <a href="chickens.html" class="btn btn-outline-primary text-start">
                        <i class="fas fa-plus-circle me-2"></i> Registrar Gallinas
                    </a>
                    <a href="produccion_huevos.html" class="btn btn-outline-success text-start">
                        <i class="fas fa-egg me-2"></i> Nueva Producción
                    </a>
                    <a href="incidentes.html" class="btn btn-outline-warning text-start">
                        <i class="fas fa-exclamation-triangle me-2"></i> Reportar Incidente
                    </a>
                    <a href="sensors.html" class="btn btn-outline-info text-start">
                        <i class="fas fa-thermometer-half me-2"></i> Ver Sensores
                    </a>
                    <a href="ventas.html" class="btn btn-outline-secondary text-start">
                        <i class="fas fa-shopping-cart me-2"></i> Registrar Venta
                    </a>
                    <a href="galpones.html" class="btn btn-outline-dark text-start">
                        <i class="fas fa-warehouse me-2"></i> Gestionar Galpones
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficas Adicionales -->
<div class="row g-3 mb-4">
    <!-- Distribución por Tipo de Gallina -->
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Distribución por Tipo</h5>
                <canvas id="tipoGallinaChart" height="200"></canvas>
                <div class="mt-3" id="tipo-gallina-legend"></div>
            </div>
        </div>
    </div>

    <!-- Estado de Galpones -->
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Ocupación de Galpones</h5>
                <canvas id="galponesChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Incidentes del Mes -->
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Incidentes - Este Mes</h5>
                <div class="list-group list-group-flush" id="incidentes-list">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actividad Reciente y Sensores -->
<div class="row g-3 mb-4">
    <!-- Monitoreo de Sensores -->
    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Monitoreo de Sensores</h5>
                    <span class="badge bg-success">En línea</span>
                </div>
                <div class="row g-2" id="sensores-container">
                    <!-- Sensor Temperatura -->
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Temperatura</small>
                                <i class="fas fa-thermometer-half text-danger"></i>
                            </div>
                            <h4 class="mb-0" id="sensor-temp">25°C</h4>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-danger" style="width: 65%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Sensor Humedad -->
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Humedad</small>
                                <i class="fas fa-tint text-primary"></i>
                            </div>
                            <h4 class="mb-0" id="sensor-hum">60%</h4>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-primary" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Sensor CO2 -->
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">CO₂</small>
                                <i class="fas fa-wind text-info"></i>
                            </div>
                            <h4 class="mb-0" id="sensor-co2">450 ppm</h4>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-info" style="width: 45%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Sensor Luz -->
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Luminosidad</small>
                                <i class="fas fa-sun text-warning"></i>
                            </div>
                            <h4 class="mb-0" id="sensor-luz">750 lux</h4>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-warning" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actividad Reciente -->
    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Actividad Reciente</h5>
                <div class="timeline" id="actividad-reciente">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <small class="text-muted d-block">Hace 10 min</small>
                            <p class="mb-0">Producción registrada: 1,250 huevos</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <small class="text-muted d-block">Hace 45 min</small>
                            <p class="mb-0">Nuevo registro de gallinas en Galpón B</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <small class="text-muted d-block">Hace 2 horas</small>
                            <p class="mb-0">Alerta: Temperatura alta en Galpón C</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <small class="text-muted d-block">Hace 3 horas</small>
                            <p class="mb-0">Venta procesada: 500 unidades</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos personalizados para el timeline */
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e7e9ed;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-marker {
        position: absolute;
        left: -24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #e7e9ed;
    }

    .timeline-content {
        padding-left: 10px;
    }

    /* Animaciones suaves */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../assets/js/api/dashboard.service.js"></script>
<script>
    // Configuración de colores Chart.js
    const chartColors = {
        primary: '#5b99ea',
        success: '#75c181',
        warning: '#f6c23e',
        danger: '#e74a3b',
        info: '#36b9cc',
        gray: '#a9b5c9',
        border: '#e7e9ed'
    };

    // Variables globales para los gráficos
    let produccionChart = null;
    let tipoGallinaChart = null;
    let galponesChart = null;

    // Función principal para cargar todos los datos del dashboard
    async function cargarDatosDashboard() {
        try {
            // Mostrar indicadores de carga
            document.getElementById('total-gallinas').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('produccion-hoy').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('galpones-activos').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('alertas-activas').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';

            // Cargar datos completos del dashboard
            const data = await dashboardService.getDashboardCompleto();

            // Actualizar métricas principales
            actualizarMetricas(data.metricas);

            // Cargar gráficos
            cargarGraficoProduccion(data.produccion_semanal);
            cargarGraficoTipoGallina(data.distribucion_tipos);
            cargarGraficoGalpones(data.ocupacion_galpones);

            // Cargar incidentes
            cargarIncidentes(data.incidentes_recientes);

            // Actualizar sensores
            actualizarSensoresData(data.sensores);

            // Cargar actividad reciente
            cargarActividadReciente(data.actividad_reciente);

            // Actualizar sensores cada 10 segundos
            setInterval(async () => {
                try {
                    const sensores = await dashboardService.getSensores();
                    actualizarSensoresData(sensores);
                } catch (error) {
                    console.error('Error actualizando sensores:', error);
                }
            }, 10000);

        } catch (error) {
            console.error('Error cargando datos del dashboard:', error);
            mostrarError('Error al cargar los datos. Por favor, recarga la página.');
        }
    }

    // Actualizar métricas principales
    function actualizarMetricas(metricas) {
        document.getElementById('total-gallinas').textContent = metricas.total_gallinas.toLocaleString();
        document.getElementById('produccion-hoy').textContent = metricas.produccion_hoy.toLocaleString();
        document.getElementById('galpones-activos').textContent = metricas.galpones_activos;
        document.getElementById('alertas-activas').textContent = metricas.alertas_activas;
        document.getElementById('gallinas-trend').textContent = metricas.gallinas_trend;
        document.getElementById('produccion-trend').textContent = metricas.produccion_trend;
    }

    // Gráfico de Producción Semanal
    function cargarGraficoProduccion(data) {
        const ctx = document.getElementById('produccionChart').getContext('2d');

        if (produccionChart) {
            produccionChart.destroy();
        }

        produccionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Esta Semana',
                    data: data.data_actual,
                    borderColor: chartColors.success,
                    backgroundColor: 'rgba(117, 193, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Semana Anterior',
                    data: data.data_anterior,
                    borderColor: chartColors.gray,
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString() + ' uds';
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico de Distribución por Tipo de Gallina
    function cargarGraficoTipoGallina(data) {
        const ctx = document.getElementById('tipoGallinaChart').getContext('2d');

        if (tipoGallinaChart) {
            tipoGallinaChart.destroy();
        }

        const labels = data.map(item => item.tipo);
        const valores = data.map(item => item.cantidad);
        const colores = [
            chartColors.primary,
            chartColors.success,
            chartColors.warning,
            chartColors.info,
            chartColors.danger
        ];

        tipoGallinaChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: valores,
                    backgroundColor: colores.slice(0, valores.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Gráfico de Ocupación de Galpones
    function cargarGraficoGalpones(data) {
        const ctx = document.getElementById('galponesChart').getContext('2d');

        if (galponesChart) {
            galponesChart.destroy();
        }

        const labels = data.map(item => item.nombre);
        const valores = data.map(item => item.ocupacion_porcentaje);
        const colores = valores.map(val => {
            if (val >= 90) return chartColors.danger;
            if (val >= 75) return chartColors.warning;
            return chartColors.success;
        });

        galponesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ocupación (%)',
                    data: valores,
                    backgroundColor: colores
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Cargar incidentes recientes
    function cargarIncidentes(incidentes) {
        const incidentesList = document.getElementById('incidentes-list');

        if (!incidentes || incidentes.length === 0) {
            incidentesList.innerHTML = '<div class="text-center py-3 text-muted">No hay incidentes recientes</div>';
            return;
        }

        incidentesList.innerHTML = incidentes.map(inc => `
        <div class="list-group-item border-0 px-0">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <span class="badge bg-${inc.severidad} mb-1">${inc.tipo}</span>
                    <p class="mb-0 small">${inc.descripcion}</p>
                    <small class="text-muted">${inc.tiempo}</small>
                </div>
                <i class="fas fa-chevron-right text-muted"></i>
            </div>
        </div>
    `).join('');
    }

    // Actualizar datos de sensores
    function actualizarSensoresData(sensores) {
        document.getElementById('sensor-temp').textContent = sensores.temperatura.toFixed(1) + '°C';
        document.getElementById('sensor-hum').textContent = sensores.humedad.toFixed(0) + '%';
        document.getElementById('sensor-co2').textContent = sensores.co2 + ' ppm';
        document.getElementById('sensor-luz').textContent = sensores.luminosidad + ' lux';
    }

    // Cargar actividad reciente
    function cargarActividadReciente(actividades) {
        const actividadContainer = document.getElementById('actividad-reciente');

        if (!actividades || actividades.length === 0) {
            actividadContainer.innerHTML = '<div class="text-center py-3 text-muted">No hay actividad reciente</div>';
            return;
        }

        actividadContainer.innerHTML = actividades.map(act => `
        <div class="timeline-item">
            <div class="timeline-marker bg-${act.color}"></div>
            <div class="timeline-content">
                <small class="text-muted d-block">${act.tiempo}</small>
                <p class="mb-0">${act.descripcion}</p>
            </div>
        </div>
    `).join('');
    }

    // Mostrar mensaje de error
    function mostrarError(mensaje) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
        document.querySelector('.row').insertBefore(alertDiv, document.querySelector('.row').firstChild);
    }

    // Inicializar dashboard al cargar la página
    document.addEventListener('DOMContentLoaded', cargarDatosDashboard);
</script>